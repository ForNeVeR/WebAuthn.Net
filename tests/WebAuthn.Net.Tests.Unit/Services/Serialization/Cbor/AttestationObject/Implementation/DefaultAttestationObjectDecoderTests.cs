using System;
using System.Security.Cryptography;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.WebUtilities;
using Microsoft.Extensions.Logging.Abstractions;
using NUnit.Framework;
using WebAuthn.Net.Models.Abstractions;
using WebAuthn.Net.Services.Cryptography.Cose.Implementation;
using WebAuthn.Net.Services.Cryptography.Sign.Implementation;
using WebAuthn.Net.Services.RegistrationCeremony.Implementation;
using WebAuthn.Net.Services.RegistrationCeremony.Implementation.Verification;
using WebAuthn.Net.Services.Serialization.Cbor.AttestationObject.Implementation.AttestationStatements;
using WebAuthn.Net.Services.Serialization.Cbor.AttestationObject.Models.Enums;
using WebAuthn.Net.Services.Serialization.Cbor.Format.Implementation;
using WebAuthn.Net.Services.TimeProvider.Implementation;

namespace WebAuthn.Net.Services.Serialization.Cbor.AttestationObject.Implementation;

public class TestWebAuthnContext : IWebAuthnContext
{
    public TestWebAuthnContext(HttpContext? httpContext)
    {
        HttpContext = httpContext!;
    }

    public ValueTask DisposeAsync()
    {
        GC.SuppressFinalize(this);
        return ValueTask.CompletedTask;
    }

    public HttpContext HttpContext { get; }

    public Task CommitAsync(CancellationToken cancellationToken)
    {
        return Task.CompletedTask;
    }
}

[TestFixture]
public class DefaultAttestationObjectDecoderTests
{
    private static readonly byte[] PackedAttestationObject = Convert.FromHexString(
        "A363666D74667061636B65646761747453746D74A363616C67266373696758473045022100A1297689636AA5001C079A65B56D9696AC17A755DCB600CCC169F62D26BFC820022052A479E66E3ADD4A18D054BE778FBC646B5AE830C8AB777ED45E3A7923B42B5E63783563815902C1308202BD308201A5A003020102020418AC46C0300D06092A864886F70D01010B0500302E312C302A0603550403132359756269636F2055324620526F6F742043412053657269616C203435373230303633313020170D3134303830313030303030305A180F32303530303930343030303030305A306E310B300906035504061302534531123010060355040A0C0959756269636F20414231223020060355040B0C1941757468656E74696361746F72204174746573746174696F6E3127302506035504030C1E59756269636F205532462045452053657269616C203431333934333438383059301306072A8648CE3D020106082A8648CE3D0301070342000479EA3B2C7C49701062230CD23FEB60E5293171D483F100BE859D6B0F83970301B546CDD46ECFCAE3E3F30F81E9ED62BD268D4C1EBD37B3BCBE92A8C2AEEB4E3AA36C306A302206092B0601040182C40A020415312E332E362E312E342E312E34313438322E312E373013060B2B0601040182E51C0201010404030205203021060B2B0601040182E51C01010404120410CB69481E8FF7403993EC0A2729A154A8300C0603551D130101FF04023000300D06092A864886F70D01010B05000382010100979D0397D860F82EE15D311C796EBAFB22FAA7E084D9BAB4C61BBB57F3E6B4C18A4837B85C3C4EDBE48343F4D6A5D9B1CEDA8AE1FED491292173058E5EE1CBDD6BDAC07557C6A0E8D36825BA159E7FB5AD8CDAF804868CF90E8F1F8AEA17C016B55C2A7AD497C894FB71D753D79B9A484B6C376D723B998D2E1D4306BF1033B5AEF8CCA5CBB2568B6924226D22A358AB7D87E4AC5F2E091AA71579F3A56909497D72F54E06BAC1C3B4413BBA5EAF94C3B64F34F9EBA41ACB6AE283776D3646537848FEE884BDDDF5B1BA579854CFFDCEBAC344059527E56DD598F8F566715ABE4301DD191130E6B9F0C640391253E229803F3AEF274BEDBFDE3FCBBD42EAD679686175746844617461589449960DE5880E8C687434170F6476605B8FE4AEB9A28632C7995CF3BA831D97634500000013CB69481E8FF7403993EC0A2729A154A80010BE6E2A2BFE37BCE9C290665FEEA119F6A5010203262001215820CB0CADC1A7FFC93F98562E46FD442FE9FD886D408B4D5DB64C0D9CA148B265F2225820AA88B476B3CEC3EACF27F65008FE0B1B88E13B5C61276AB41A119134A144FAF9");

    private static readonly byte[] NoneAttestationObject = Convert.FromHexString(
        "A363666D74646E6F6E656761747453746D74A068617574684461746158ECCC750CF9F5DEF1F3D373B21074053CC61A2746665E0F39D1A89A9E71D55171434561F3B3A3ADCE000235BCC60A648B0B25F1F05503006801A779D12CF2ED915BF1FEF075F32614ED9D51D401F12B4CAD805B849A6B4C224829575B22232CF5D0004CA3AF529A0A7E6CA1EBAD99B0ED49E4F414B22F7228DBA60D1F990F8C1EBC36199F0A6BCAD19FE6B9FAC9DCB1410B4160F4B04BCBB6DC575507106A1DAFA5010203262001215820C1BB6377CE78679C2E97E7ED717FB15E0E4DCE35B6C6C43D210219F0A22B8F342258201FDFAA55E866E868F6E52C996AED7B981E5CD18A1358167C9E074491AE04A8E6");

    private static readonly byte[] TpmAttestationObject = Convert.FromHexString(
        "A363666D746374706D6761747453746D74A663616C6739FFFE63736967590100AA01C1A88B62055C2179C71A248D1E72380C0AFF5D6208EAADF210A4A4713DAD6EB4D89DCA8E1711433A057F553166F69DC2661C1C73310D00E656E3A11FEC96F837C04554FB3B7333961873AC64CD3BFFA384616C19E11DCF446036CBE20DD6953F994DB15E8F7B86CC86006FD5A4E4934CF1D53F2CC4AF01EE0293EB1F344485A0F3DFDA618E201D1E27EB94910E9DA03862362070EFA93C2277279A00754F6C3AC5F220DB43CF0EF861FF7E1780B45B608DB22AF9741BC1577342161D5B22F45D553018B492B8006E078B1E44F9326422A8394E95BAE4337D63691F6365D39C9B7578B6EC7CAC51EC607CFC62841DCF6D1F0B25D8B58F4E2D460DC9BC152F6376657263322E3063783563825905BB308205B73082039FA0030201020210611989A4A50242A9A9A40E28362658F9300D06092A864886F70D01010B05003041313F303D060355040313364555532D4E54432D4B455949442D45344138363636463846344336443943333933324139343838343737383041363831304334323133301E170D3232303131323232313531385A170D3237303631303138353433365A300030820122300D06092A864886F70D01010105000382010F003082010A0282010100AA3EEC31DD8A2A594F37C0F5FA536883152BCF3BCCCD275C0548BD4D2498602C3E94D86DFEDD9F50C097A061703917B365ABC183F4D8AF11C5758E1788DFEDEB0C00892BEB9CCF5AA2F2B3C59134CEB477B83D18E003C1B37CAAB63485EA52B1A2708E1B306CD248E8BF2F2709E7AD0E945950A6DF11EA9FC081DA2496352527B21813413909D5911D4E8783E75B055D41347D2C578F2222480003E2D088664987155A9C8737EA5208A233F99B6CACD49F1119E9CEABDFD71C1F36E6E08AFEBBADAB7A9427557293A731416C9F84835E5112FC3AC6E61A1ADA48B64DBB01755C12875F03295FEE98103DF1315A4A0C65F6FC7DAA9B4008F9C76F66049BE5CE3D0203010001A38201EA308201E6300E0603551D0F0101FF040403020780300C0603551D130101FF04023000306D0603551D200101FF04633061305F06092B060104018237151F3052305006082B0601050507020230441E420054004300500041002000200054007200750073007400650064002000200050006C006100740066006F0072006D00200020004900640065006E007400690074007930100603551D25040930070605678105080330500603551D110101FF04463044A4423040313E3010060567810502020C074E5043543735783014060567810502010C0B69643A34453534343330303014060567810502030C0B69643A3030303730303032301F0603551D2304183016801437CA302D497AE769234EB73CB53C45F138ED5950301D0603551D0E04160414D669771F94F3AECD0D7AFEBDB453613D99E1695D3081B206082B060105050701010481A53081A230819F06082B06010505073002868192687474703A2F2F617A637370726F6465757361696B7075626C6973682E626C6F622E636F72652E77696E646F77732E6E65742F6575732D6E74632D6B657969642D653461383636366638663463366439633339333261393438383437373830613638313063343231332F65303163323036322D666264632D343061352D613430662D6333373763306637363531632E636572300D06092A864886F70D01010B0500038202010033F981AB8F44BCE35832319BA2B7EAAC2A928D7716E46848720756DA7B11C670CCC2DB2D4ED64A53AE9687DC8F3486B21916D628036C4A4358FAEEEA02EAF9B53E1B0907AAA1B3D4FBCE6599D55B657894D818D67F6D8636C28EB9A891C50794D791EBC95157B61B7F6407F5B54CA07A83F192C1BE1AE5EE03FD28E9EDBED1669C882874F5FD41351F8457811F508BAF0AE1655A2572544BA4F83C7AD17383DE194A092D01541B162891621FE39E86DF61B01A0BD4497EFA2BBEE956FE18FA44F7BF978425D631952E04553D776B5ECA59DD0374B8DED007BAF6AFC341296B1D52D4AC00EFB9931E33C8F1C8F42F0DBEC44CA2EC4947879BBDCA38218B4AD706437A41E3D9EDDDDF5775609C53052B99B045D86EC7B1181335B8F5E86E9051C5ABA1012A36B046E3D68EF66319D0DC129F9777A0DB974978CB746057335BA42D9F8636B643630E4A5D4D74DBFE55A47A63207AD987475783743D7AE70A7BA12415B1FAE7E3B955A416527479589A6DEBE7E5FE5D221EA1E72976E02FAB6379EAC2A99583BC5B0E6A4D3947E868B00A10B3F362D04B2066A1F047F5651BCE9FB12C02554DFFB0329336CFC97B4F1EC09FDB6CC0794EAEA4D52C6CF00C3C47DE84C2340BA77CFE66F6B59B253E29EAD86150E5E4176F80FA9B0FC5E6B2DFB3EAFACFDC225BB6BF2382A552ED15B2FDC24E03C28267A212FFBE504FB19B96AE94185906EF308206EB308204D3A003020102021333000006D3B67CE72AC3AB07E80000000006D3300D06092A864886F70D01010B050030818C310B3009060355040613025553311330110603550408130A57617368696E67746F6E3110300E060355040713075265646D6F6E64311E301C060355040A13154D6963726F736F667420436F72706F726174696F6E313630340603550403132D4D6963726F736F66742054504D20526F6F7420436572746966696361746520417574686F726974792032303134301E170D3231303631303138353433365A170D3237303631303138353433365A3041313F303D060355040313364555532D4E54432D4B455949442D4534413836363646384634433644394333393332413934383834373738304136383130433432313330820222300D06092A864886F70D01010105000382020F003082020A0282020100903B18BC075966E7D87F03469A7141FADEE33965D6C804DD6C6DF434D85ADE7EBFEC4AC0241BEB3FFB175A72ECB31EE7CA8BAA0940815852EA712F376A6E6751B37A376C145C73DA0C847C7D72F97DD11A9D1DC52E942B012D9A4B1A3042884509F61A029D5248AEBE46B16A8CE7B84C684CFCAED1A5E4EB216C5F92840EEF5464282DEBA6D1CBA9B72884679F554AD9FAD97EA1988BC0BCC7D43AF68186DF5EAD5300089B7CA90EDBF7A51117B032D813553922B76FDF68732780AAA8FC9ABBEA894B5F1BF02B23BE03A9A705D14B0A4E994ED2DF1AA8F85EE1D5E785C36B601DCECF10FB7C31248A79B6BC173E90CA22E1805AFC8C552F291CE4E01E351C550CA9761AC1B840B5F2018861AC1ABADD34A6FB3312129C7D44EB22D509018685788DF54ED5D21F069F9E9E2B3A291A5B9BC3BC8C9A0BBC0AEDB0057FDAFE31662011E79FC620C1C466E8DBD3F7A29C9431E716A3D59B73A7D766C6DF517B1189084462DB6934FA6AF12EF6B2FA0099FB5EBDB8E526BA742FCE48C44AA8B4AE7F1A7A3BA7F64C7DA0E24BD3D06A3D49EC8CDBF69C063222434AC57813A6E3D1F813855C25EA5FEFD164963A2F0FAF2299E6793178F17A9702CD2D77F37EF825E87B936F0978FC099E30F14BC9FD0EBEB1394DFFC314B580DE5C5BA7174A888F19ED09338084C80714B4AAEFA545A84DA8F1C67CA566EBD2F28BB6B617C7D8F4250203010001A382018E3082018A300E0603551D0F0101FF040403020284301B0603551D250414301206092B06010401823715240605678105080330160603551D20040F300D300B06092B060104018237151F30120603551D130101FF040830060101FF020100301D0603551D0E0416041437CA302D497AE769234EB73CB53C45F138ED5950301F0603551D230418301680147A8C0ACE2F486217E294D1AE55C152EC7174A45630700603551D1F046930673065A063A061865F687474703A2F2F7777772E6D6963726F736F66742E636F6D2F706B696F70732F63726C2F4D6963726F736F667425323054504D253230526F6F742532304365727469666963617465253230417574686F72697479253230323031342E63726C307D06082B060105050701010471306F306D06082B060105050730028661687474703A2F2F7777772E6D6963726F736F66742E636F6D2F706B696F70732F63657274732F4D6963726F736F667425323054504D253230526F6F742532304365727469666963617465253230417574686F72697479253230323031342E637274300D06092A864886F70D01010B0500038202010056534A2B42212BE597A8BAACF50F77C5ADDA6A20470E88FDCF9D590CDD73DF9263D89A2065EA5523CA28E940614DA3BBB9EF37A02FAC86DAEAC9E01DE5340144DE835519E7E6C314E59D4A03DA1B21FF10DFE5FAF6D5E9224FCCE9991C93877F0D964FC86394569368A6115F1CC51FB3D44789F11916D6B5D206810854956839A28FC53B86EF2CA7ECB0F48E367EBCE2A9005627ABABE972D567AA27339885DE04CA581527D34BDD852183C7587070227A9B43CC5ECE703A9F7DBB992D9531EB173289B85641C9ED021EDADF13F0A97C4436C1E199EFDBAB0FE4A9AF8D564F96CF8CDDA2234D2D1BD498248BD562DCE093EC149D3C1249F5916EDFF592A789EE5AC3EDBD8C47FA28806DE251830F7B574DF68E56F59C0DBBBDDA330E3B57611088FADC0C10883260661AA7AE98E5C9653F5F421542568F060F34004D18DECC35A0CAD8D17C1D7905234A91FA7B97D360AACD07A34C4F58D71A3288CD583C5DB3D696779B3F6C0486AF2B6220D1DF56FD07D4B0FE768AED76FE0AA8BE550754B649D28DE963BACAC1A71194C7E10825C8B4F9DCDE5D14F9FF7EFABF2292B98C40D577768DDE0492724B20054B4F7ADBD740C2B8A18B0E069F6EC7D307156811AF614A360E654AFF9B7595EADE88F563D88D5CA1CA2EDF084206E0913B61B3389DAE23839AB70CCF226C4F23CAE7C0AB43DF2594C9CA2EDCD90D8DFFD3609C2370677075624172656158760023000B0004007200209DFFCBF36C383AE699FB9868DC6DCB89D7153884BE2803922C124158BFAD22AE001000100003001000201E93B8360BC4DE3914682B1B8DEC7AC9E4E8A7546B87CC4818383C94B05F43D700208173CF5E7F8F9BFE081747385D56898E61CEDC4076281C1D83F2FAD0DD082FDC6863657274496E666F58A1FF54434780170022000BD03464CB6B6C13EAEF122830DDC2481AAB90A687A8DC0FFE942EF33D666BDD6F0014B4C2270F75AD1927561CF5A28CCAD6FD37D8A3E8000000013EE05E9ACDD2CB0BB8690B0601EF3988EA2C8ED5C80022000B914F4626522738D830D9C0CFDCC5B4CEB6A39EC5270BFC17980D11C8A8AA11F00022000B2557C6AD706610ECA93A9D62BEEF414509DEFC1656B94DD1942FE471671EA59D68617574684461746158A474A6EA9213C99C2F74B22492B320CF40262A94C1A950A0397F29250B60841EF0450000000008987058CADC4B81B6E130DE50DCBE96002086C4B6CB0173FCB59FF7E942DF9BC2F6E253543DD9095770799BC44946E35E74A50102032620012158201E93B8360BC4DE3914682B1B8DEC7AC9E4E8A7546B87CC4818383C94B05F43D72258208173CF5E7F8F9BFE081747385D56898E61CEDC4076281C1D83F2FAD0DD082FDC");

    private static readonly byte[] TpmRsaAttestationObject = Convert.FromHexString(
        "A363666D746374706D6761747453746D74A663616C6739FFFE6373696759010048C2EF4B3C097E2E0C654733E5BE7ECBFB4CAE3271459F55C02F15ED1A7982E7EA0C208A9F5095856E005B90DDA5DB33ECA8E0914F919053CB9C28D23A1EB95BB8301422AEF08DCC46E53CE042DDD8B46316B6011CAD99F679C5254052A363AEFFC1922E1CBCB8E372A2D528C4ACD3EB32B9083DEF65C858486A5320AD62C2A25E34818215AFFF712DF8325F9E5CED7881F976D42A10CB52FE6E3C0DC2480896796C16C76E8AD814D5F39BC7B1A1BA7F66054DF7104C5B357134B0326EC0F42D92890ECDD3510DC0CD6EAD5C650AFB84B018225DAA51EF43B2ABF71F884358634B62EFFC367EF8A499FBF4CF43B5709380C949585A39D6853EF4EDC86B5669056376657263322E30637835638259045F3082045B30820343A003020102020F046C3ADDA29979D5E59E017ED72A7F300D06092A864886F70D01010B05003041313F303D060355040313364E43552D4E54432D4B455949442D33363130344345343042424343314634304438344134424244353042453939303234443935374434301E170D3138303230313030303030305A170D3235303133313233353935395A300030820122300D06092A864886F70D01010105000382010F003082010A02820101009B0FB87E2714451FEC8157D6EDCB35891A0319DC6306909CCC5DB7DDB6BFE564CFF91AEC6193E5CD681237D597A6DBB2C338D9A0395B89DECD95DB92475645B1DB386D6EF52F22832FAD9ECAA6A201CEB8E60A1C5C0CB17432032407A8FB737D0E6E2FB30F86CBFD2C776BF55049018568EE13580BE6171A07D12D5D20EF1CFC26ADFD1E627FF8716BBD031A92C699FBF4920F604394AD446BD87F33C86E3F3F48F56B7315066B40CA68695C19FD8A56BE6D6ECAFE4D09617061E72018643B261E016C5DB51AB8359D8DADC763391EA7D8D790571E81738C8CFAFF412A964636B012FCE8A6B9C9F90AA858D6DA461B83F949DF80235BC2C794F24674690363050203010001A382018F3082018B300E0603551D0F0101FF040403020780300C0603551D130101FF0402300030530603551D200101FF04493047304506092B060104018237151F3038303606082B06010505070202302A132846414B45204649444F2054435041205472757374656420506C6174666F726D204964656E7469747930100603551D250409300706056781050803304A0603551D110101FF0440303EA43C303A3138300E060567810502030C0569643A31333010060567810502020C074E5043543678783014060567810502010C0B69643A4646464646314430301F0603551D2304183016A014517F22C8E653A57CD54CDD30587E30FF67368C5D301D0603551D0E041604143BA4949A23A108755972AFBCF1A720DAE424433F307806082B06010505070101046C306A306806082B06010505073002865C68747470733A2F2F6669646F616C6C69616E63652E636F2E6E7A2F74706D706B692F4E43552D4E54432D4B455949442D333631303443453430424243433146343044383441344242443530424539393032344439353744342E637274300D06092A864886F70D01010B05000382010100208C95064724FD20F69DB8F828EC1423A718647AE3C2B7142E81223925E7F538D322207931D04CBEAA8DC805E2C96A1677518473F308DE628ECEEE20E544D5410A9F88E4EBA9FB99AE9A14D2D01EA232A764B8F6C188F91A9C8E7C490F2B79BDA95683C6262B87A692F1ADF0FC8A20F3BF048886A85402DB06DE6E01F8744C01C7C127711ED53C0D126B0B8DF222A70FF5BC91AACB099A048D7293008F0FE170A2710CC0F652EAEFB0C6ACAB25AF2B9DF7C8D034F95C17BE4DC723422D48EC3F837E760FEA8E4C723CDA52488DCDF22A868D7982A7ED1CE070B005EC07AC4E288945E636914FEF2F27FEC07E78FB4F13DE8C81049A41087735CBF2EDE5DDAA5859060830820604308203ECA0030201020210D053A447848799694E0791ED54FDA107300D06092A864886F70D01010B05003081BF310B3009060355040613025553310B300906035504080C024D593112301006035504070C0957616B656669656C6431163014060355040A0C0D4649444F20416C6C69616E6365310C300A060355040B0C034357473136303406035504030C2D4649444F2046616B652054504D20526F6F7420436572746966696361746520417574686F7269747920323031383131302F06092A864886F70D0109011622636F6E666F726D616E63652D746F6F6C73406669646F616C6C69616E63652E6F7267301E170D3137303230313030303030305A170D3335303133313233353935395A3041313F303D060355040313364E43552D4E54432D4B455949442D3336313034434534304242434331463430443834413442424435304245393930323444393537443430820122300D06092A864886F70D01010105000382010F003082010A0282010100D73E737D11A5077EFCB0A888B25B5F3DEDFEFA9C88E228BF08DECFBF7F0ED5608BC1BD3E1FAD3CBFA50B4B9E14604C48F70A77F44375215ED9009841DF5ED03B62171ADAFAE5866B4A2523584723B6CAD86CCD0194932846F082AA5FF2F5CC43EED23DA8E0E8F7F148E2C7FCD8F6C9DEAD90D91449D946B567D8F17181DE7FAAFBE9EDDD41DD510584B605284DEE5A6C15EC1BB3104AE4CDA1A777BFABE4FAD2DDD16E388AF33AA5B16A1541DC871F2618B0290A98E5557ADF44E682A1CF44F75846F41F9636F7A427474CEA427AE7C1F2EF2B1C43A25DA88128958A230AD59A58D9B071FBFEF8E135031FF851BDB8825DE1A41F4439C042CE96F850598B61410203010001A382017730820173300B0603551D0F04040302018630160603551D20040F300D300B06092B060104018237151F301B0603551D250414301206092B06010401823715240605678105080330120603551D130101FF040830060101FF020100301F0603551D0E04180416C214517F22C8E653A57CD54CDD30587E30FF67368C5D301F0603551D2304183016A0145C7F362D90AD5ABCBA8E75DADE3AA0EDC14E028B30680603551D1F0461305F305DA05BA059865768747470733A2F2F6669646F616C6C69616E63652E636F2E6E7A2F74706D706B692F63726C2F4649444F2046616B652054504D20526F6F7420436572746966696361746520417574686F7269747920323031382E63726C306F06082B0601050507010104633061305F06082B06010505073002865368747470733A2F2F6669646F616C6C69616E63652E636F2E6E7A2F74706D706B692F4649444F2046616B652054504D20526F6F7420436572746966696361746520417574686F7269747920323031382E637274300D06092A864886F70D01010B050003820201006D77F2DE790C5F673C96EF6CF4193B2A66C933E93677B40397E1EBD3F57C7679A9D1363C3CF771FE5397EF0E3C8E3142788414D3DC5CC6FB2A584C33ACC29781A466D34DE0CC7281D16343581364E043A6DEC3C338A28F431A926C320B44584CDB5B4B25611D47AF830F6B9EED77133AB13F22F9243F94A800E1D98E75312D2ACBB20E81E80B42FF9E27348D5201F1149ADE533CF83D4EB2CD2B13CB26035BE1F86630102A27A7569F1EC197FCA071961C640519AE44F66D4FF2FC42319EE9233790C1E09562BB37ABBBA7BB89F30402172CF234F76918154832CF79486920775C488F068929BA95FA66682B7E985BF975F7B5B7A71F9864C5FBA6B9E03944C1D332EE535638495E2574C8CDEAE56E71AD01DD2651799CE7490C413E29BEE79BAC5A4F50C3A5A7EA05CE6F103324266040E005C7518EC93C6A8413311E9D3EE4E969F92102D9838A9CF08AE78FFFF233BC548495896A6E3B2956CB038585BBE20ABC9AE43F919282567DA8048E0B104768E2F651C4C0839D2EBE1512C2EAF62926A4DAF94435D9808A3C1D00BE0B2D05AB90577EF4D07070DC1375F2B87A41073F597807026D90DC16E9EB5481E039AE45B624BA1C5E806AE6FEC64A4E3F081A0A87289A85019043D499146781261CF390AF7237EC8AB247158E38C89D21CF97E66978E2B7B08D3CB04C931F4831953B51A17D0C283B0C0071154E87B9A35BBD67707562417265615901360001000B0006047200209DFFCBF36C383AE699FB9868DC6DCB89D7153884BE2803922C124158BFAD22AE001000100800000000000100A5F6C889C2AA07276A42C042B22D0FEEEB319C643299B40D23B6FB67D5A3E521EEF0140BD03608C8E8A0E242C0CF4C255E263FD1038E3555B574678A17D9BEBCAAE0D8D067F85691782967CD3DD287E87E04F3CDA6F0E9C16F5D2685A35B3F14E60D50D92D0663877B9B5F5679E85360E9C426CF86C49C717EED7D65EC070D39187377380CEEE457870A3D52C033A6EE08A353824EC6F90DA0E79E0DDFDD8F6A0E7F0E1B7308FF9218B66D6A1A0998EF69D212222184F0A4DA5BE66A337A038B56814B2D73B42D7652843C177E213B4674A6134B0AA285A1F305077C0FE77F1C3AA070E58408B2A8E75FD8AB26848AE1A5BFAB0FA27D4B32C10BE8F955C38ECF6863657274496E666F58A1FF54434780170022000B11E68ED44DB5372E14296E2F84ACC78398751881921E30FC22A06F8B73C7945300145E8C5C0BE0517FD16DCD387E6741D93C8B1BE99D000000014770174855697B4BC68560A501737EF98D345655FB0022000B9896B9BEE49837DB9D53B04759F0D575D717785F93B7AB40052E66A69B0EB9F10022000B6ECD7FB4E26731007ABD90EEF4130DEF2423A6092D14BD0CD907608D09E197A568617574684461746159016749960DE5880E8C687434170F6476605B8FE4AEB9A28632C7995CF3BA831D97634100000075F244B67E53644FD59F90C396227317DB00205090E8509A06883405FC4119DC6FF3F4B7EAD7AFCA15A5ED3138F04D4AEB4657A401030339FFFE20590100A5F6C889C2AA07276A42C042B22D0FEEEB319C643299B40D23B6FB67D5A3E521EEF0140BD03608C8E8A0E242C0CF4C255E263FD1038E3555B574678A17D9BEBCAAE0D8D067F85691782967CD3DD287E87E04F3CDA6F0E9C16F5D2685A35B3F14E60D50D92D0663877B9B5F5679E85360E9C426CF86C49C717EED7D65EC070D39187377380CEEE457870A3D52C033A6EE08A353824EC6F90DA0E79E0DDFDD8F6A0E7F0E1B7308FF9218B66D6A1A0998EF69D212222184F0A4DA5BE66A337A038B56814B2D73B42D7652843C177E213B4674A6134B0AA285A1F305077C0FE77F1C3AA070E58408B2A8E75FD8AB26848AE1A5BFAB0FA27D4B32C10BE8F955C38ECF2143010001");

    private static readonly byte[] AndroidSafetynetAttestationObject = Convert.FromHexString(
        "A363666D7471616E64726F69642D7361666574796E65746761747453746D74A26376657268313236383530323368726573706F6E73655914A765794A68624763694F694A53557A49314E694973496E67315979493657794A4E53556C46615770445130457A5332644264306C435157644A53566C7257573831526A426E4F445A72643052525755704C6231704A61485A6A546B46525255784355554633566B524654453142613064424D565646516D684E51315A5754586849616B466A516D644F566B4A426231524756575232596A4A6B63317054516C566A626C5A365A454E4356467059536A4A68563035735933704662453144545564424D5656465158684E593149794F585A614D6E68735355567364575248566E6C6962565977535556474D57524861485A6A625777775A564E435345313651575647647A4234546E7046655531455558684E656B5530546B524F59555A334D486850524556355455524E643031455158644E52454A685455643365454E36515570435A303557516B465A56454673566C524E556B31335256465A52465A5255556C455158424557566434634670744F586C696257786F54564A5A64305A42575552575556464952454578546D497A566E566B52305A77596D6C4356324658566A4E4E556B31335256465A52465A525555744551584249596A4935626D4A4856576454567A567154564A7A64306452575552575556464552454A4B61475249556D786A4D3146315756633161324E744F584261517A5671596A49776432646E52576C4E5154424851314E7852314E4A596A4E4555555643515646565155453053554A45643046335A3264465330467653554A4255554E56616A6833575739516158684C596D4A574F484E6E575764325456526D5743746B53584E47564539725A307450624768554D476B77596D4E45526C704C4D6E4A50654570614D6E565454464E5761466C3261584261546B557A534570525758563157586447616D6C354B336C725A6D463051556454616C4A36526A46694D7A46314E444D764E3239484E57704E61444E544D7A6468624864715657493451316470564868766158425754316C33533074366456563561334646513352716247684B4E454672563246455579746165457446635539685A546C30626B4E6E5A556873624670464C3039535A32564E59586779574535446230673263334A5552564A6A61334E71656C7061636B46586545747A5A475A32566E4A59546E7044556A6C4565465A425533564A4E6B78366432673452464E734D6B56506232746963324675576973724C30707854575642516B5A6D5548647165586479596A4277636B565665544277595756576333566B4B7A42775A575634537938314B3055326133425A52307330576B7379626D7476566B78315A30553164474649636B46714F444E524B314250596D4A325433705859305A726347355753336C71627A5A4C5555467457445A58536B466E54554A42515564715A3264475230314A53554A52616B4655516D644F566B6854565556455245464C516D646E636B4A6E52555A4355574E45515652425A454A6E546C5A49556B5646526D70425657646F536D686B53464A73597A4E5264566C584E57746A62546C77576B4D31616D49794D48646851566C4A5333645A516B4A52565568425555564657455243595531444D45644451334E4851564656526B4A3651554E6F61555A765A456853643039704F485A6A523352775447316B646D497959335A614D30353554576B3553465A47546B685456555A4954586B31616D4E755558644C55566C4A5333645A516B4A525655684E515564485346646F4D47524951545A4D65546C3257544E4F64307875516E4A68557A5675596A4935626B77775A4656564D47524B5556566A656B31434D4564424D56566B5247645256304A435555633453584A5264455A534E6B4E56553274706132497A59576C74633230794E6D4E435645464E516D644F566B685354554A425A6A684651577042515531434F4564424D56566B53586452575531435955464753475A4464555A4459566F7A576A4A7A557A4E4461485244524739494E6D316D636E424D54554E46523045785657524A5156466854554A6E643052425755744C64316C43516B46495632565253555A42656B464A516D6461626D645264304A425A306C335456465A52465A534D475A435132393353305242625739445532644A62316C6E595568534D474E4562335A4D4D6B3535596B4D3164324579613356614D6A6C32576E6B3553465A47546B685456555A4954586B31616D4E746433644555566C4B5332396153576832593035425555564D516C46425247646E52554A4252693953656B3575517A5645656B4A56516E527561444A756445704D5630565261446C3652575647576D5A5154446C526232747962454676574764715632644F4F484254556C557862465A4853584230656B3134523268354D793950556C4A615647453252444A456554686F646B4E45636B5A4A4D79747351316B774D55314D4E564532574535464E564A7A4D6D5178556D6C616345317A656B513053314661546B637A61466F77516B5A4F5553396A616E4A44625578435430644C613056564D5752745156687A526B7059536D6C50636A4A44546C5243543152314F5556695446646F55575A6B51305978596E643665585572567A5A6955564E324F464645626A56505A4531544C3142785254466B5257646C6443383252556C53516A63324D55746D576C45724C3052464E6B78774D315279576C527754305A45524764596143744D5A3064506333646F525778714F574D7A646C704952307075614770776444687961324A7063693879645578485A6E6873566C6F30537A46344E555253546A42515655786B4F586C51553231715A797468616A4572644568335354467455573161566C6B3363585A504E55526E614539346145704E523278364E6D784D61567074656D396E50534973496B314A5355565952454E44515442545A30463353554A425A306C4F5157565063453143656A686A5A316B305544567756456855515535435A32747861477470527A6C334D454A4255584E475155524354553154515864495A316C45566C4652544556345A456869527A6C7057566434564746585A48564A526B7032596A4E525A3145775257644D55304A545457704656453143525564424D5656465132684E5331497965485A5A62555A7A56544A73626D4A715256524E516B56485154465652554634545574534D6E6832575731476331557962473569616B466C526E63776545353651544A4E564656335455524264303545536D4647647A423554565246655531555658644E52454633546B524B5955314755586844656B464B516D644F566B4A425756524262465A555456493064306842575552575556464C52586857534749794F5735695231566E566B684B4D574D7A555764564D6C5A355A473173616C70595458684B56454671516D644F566B4A425456524952575232596A4A6B63317054516B7069626C4A735932303162475244516B4A6B57464A76596A4E4B6347524961326453656B31335A326446615531424D4564445533464855306C694D30525252554A42555656425154524A516B52335158646E5A30564C5157394A516B46525245745661335A78534859765430704864573879626B6C5A59553557563168524E556C58615441785131686159586F3256456C49544564774C327850536973324D4441764E476869626A6432626A5A425155497A52465A365A46465064484D33527A567753444279536D357554305A56515573334D556330626E704C54575A495130645661334E584C323176626D457257544A6C625570524D6B347259576C6A6430704C5A58525153314A545357644264564250516A5A425957686F4F4568694D6C68504D326735556C56724D6C51775345357664554979566E70346230315962477435567A64595656493162586332536D744D534735424E544A5952465A76556C5258613035306554567651306C4F54485A486257355363306F78656D39315158465A52315A5254574D764E334E354B7939465757684254484A57536B56424F45746964486C594B33493463323533565456444D576856636E6468567A5A4E56303942556D453463554A77546C466A5631527259556C6C62316C326553397A52306C4B52573171556A4232526B5633534752774D574E545956644A636A59764E4763334D6D34335433465964325A70626E5533576C6C584F5464465A6D39505531464B5A5546365157644E516B46425232706E5A30563654556C4A516B7836515539435A30355753464534516B466D4F4556435155314451566C5A6430685257555257556A4273516B4A5A64305A4257556C4C64316C43516C4656534546335255644451334E4851564656526B4A3354554E4E516B6C48515446565A455633525549766431464A5455465A516B466D4F454E42555546335346465A52465A534D453943516C6C46526B686D51335647513246614D316F7963314D7A513268305130527653445A745A6E4A77544531434F4564424D56566B535864525755314359554647536E5A70516A466B626B68434E3046685A324A6C56324A545955786B4C324E4857566C315455525652304E446330644255565647516E6446516B4A446133644B656B4673516D646E636B4A6E52555A4355574E3351566C5A576D4649556A426A5247393254444935616D4D7A5158566A523352775447316B646D497959335A614D3035355457704265554A6E546C5A49556A684653337042634531445A57644B5955467161476C4762325249556E64506154683257544E4B63307875516E4A68557A5675596A4935626B77795A48706A616B6C32576A4E4F655531704E57706A625864335548645A52465A534D47644352476433546D70424D454A6E576D356E555864435157644A64307471515739435A326479516D6446526B4A5259304E42556C6C6A595568534D474E4954545A4D65546C3359544A7264566F794F585A6165546C35576C6843646D4D79624442694D306F3154487042546B4A6E6133466F61326C484F586377516B465263305A4251553944515646465155684D5A55707364564A554E324A32637A49325A336C42576A687A627A677864484A5653564E6B4E3038304E584E72524656745157646C4D574E75654768484D564179593035745533686956334E7661554E304D6D563165446C4D55305172554546714D6B784A57564A475346637A4D53383265473970597A46724E4852695631687252454E716158497A4E33685556453578556B464E55465635526C4A58553252326443747562464278643235694F4539684D6B6B7662574654536E567259336845616B35545A6E4245614339435A444673576B356E5A4751764F474E4D5A484E464D797433655842315A6B6F35645668504D576C526347356F4F58706964555A4A64334E4A54303548624446774D304534513264346133464A4C3156426157677A536D46485433466A63474E6B59554E4A656D74435956493564566C524D566730617A4A575A7A564255464A4D62335636566E6B335954684A566D7332643356354E6E42744B3151335346513054466B3461574A544E555A46576D786D51555A4D55316334546E647A566E6F3555304A4C4D6C5A78626A464F4D46424A5457343165454532546C7057597A64764F444D3152457842526E4E6F5256646D517A64555357557A5A7A3039496C31392E65794A756232356A5A534936496D785861306C71654464504E486C4E63465A42546D5232556B525965585650556B314762323556596C5A616454517657486B33535842325A464A425155464251554642515546425155464251554642515546425155464251554642515546425156464C5A32783453486C6D626C4A4C5156705763576C4B5A456C786448466D4E456B355A486777623038324C337042547A6855626B5276616E5A46576B46784D6B526161304A355354466D59323958566C4646635339504D305A4D5344566854336436596E4A7965484A4B4E6A56564E57525A6357784255556C45536D6C42516B6C575A32646F4E55394B5A6C6C535248705752306C76643074785654553351573576566D70715A473174616B64704F5870735457747151565A574F555242615664445248497761564E704D485A705355744F554531555357524F4D6A686E5630357461324E3354334932524646344E6A5A4E55475A6D4D30396B625374314E6D564B63557843624446494D6C4D7964484A42516B684D61573572626E4E35566B315162533943546C5657576A4A4B526D78794F4441694C434A306157316C633352686258424E637949364D5455794F446B784D54597A4E444D344E537769595842725547466A6132466E5A553568625755694F694A6A623230755A3239765A32786C4C6D46755A484A76615751755A32317A496977695958427252476C6E5A584E30553268684D6A5532496A6F69536B39444D3156726332787A64565A364D544E6C54334275526B6B35516E424D623346435A7A6C724D55593254325A68554852434C306471545430694C434A6A64484E51636D396D6157786C54574630593267694F6D5A6862484E6C4C434A68634774445A584A3061575A70593246305A5552705A32567A64464E6F595449314E69493657794A48574664354F4668474D335A4A6257777A4C30316D626D315462586C3153304A7756444E434D475258596B685355693830593264784B32644250534A644C434A6959584E7059306C756447566E636D6C30655349365A6D467363325573496D466B646D6C6A5A534936496C4A4655315250556B566656453966526B46445645395357563953543030735445394453313943543039555445394252455653496E302E6943463644326F733844597544564F6E74337A444A42326D53586E5A6A74574A746C5F6A7A534478354D725243394132666D46425A367A356B70515A324D6951376F6F746A39576B484D6778714968725833646C6832504F4841776B4953333479536A4C564E7353507072453834655A677153464C4D4559543047523265564C48414D504E386E3552384B366275444F4746336E536936474B7A4735375A6C6C3843536F623279694153397237737064413648305444482D4E477A5364624D49496438665A4431647A464B4E5172373762366C62494146675162525A42726E702D652D48346948366432316F4E324E4159526E5235595552616350366B47476A3263467873774532393038777876396869594E4B4E6F6A656575385863344974375062686C41754F37797768514641383169504343466D3131423863665558625741386C5F3274744E5042454D474D362D5A3656795168617574684461746158C49569088F1ECEE3232954035DBD10D7CAE391305A2751B559BB8FD7CBB229BDD44000000000000000000000000000000000000000000040A825C47C9F9D1280655AA225D22AB6A7F823D771D283BAFF300EF139C3A23BC4640AB60D9901C88D5F728595404ABF3B714B1F968EC336EBAF1AC9EB9539758AA50102032620012158208793897D8443CD5188A302AA539EC09E85638DD9A68C68BDCE53248C0555F430225820EBD224A2D2F88828D3CC4C874DDBC81636691CC0EAFA0D0C7AE8C3DF7F739D9B");

    private static readonly byte[] AndroidKeyAttestationObject = Convert.FromHexString(
        "A363666D746B616E64726F69642D6B65796761747453746D74A363616C6726637369675846304402202CA7A8CFB6299C4A073E7E022C57082A46C657E9E53B28A6E454659AD024499602201F9CAE7FF95A3F2372E0F952E9EF191E3B39EE2CEDC46893A8EEC6F75B1D956063783563835902CE308202CA30820270A003020102020101300A06082A8648CE3D040302308188310B30090603550406130255533113301106035504080C0A43616C69666F726E696131153013060355040A0C0C476F6F676C652C20496E632E3110300E060355040B0C07416E64726F6964313B303906035504030C32416E64726F6964204B657973746F726520536F667477617265204174746573746174696F6E20496E7465726D656469617465301E170D3138313230323039313032355A170D3238313230323039313032355A301F311D301B06035504030C14416E64726F6964204B657973746F7265204B65793059301306072A8648CE3D020106082A8648CE3D030107034200043849A20FDE26C34B0088391A5827783DFF93880B1654088AADFAF57A259549A1743C4B5245CF2685CF91054367CD4FAFB9484E70593651011FC0DCCE7621C68FA38201313082012D300B0603551D0F0404030207803081FC060A2B06010401D6790201110481ED3081EA0201020A01000201010A010104202A4382D7BBD89D8B5BDF1772CFECCA14392487B9FD571F2EB72BDF97DE06D4B60400308182BF831008020601676E2EE170BF831108020601B0EA8DAD70BF831208020601B0EA8DAD70BF853D08020601676E2EDFE8BF85454E044C304A31243022041D636F6D2E676F6F676C652E6174746573746174696F6E6578616D706C65020101312204205AD05EC221C8F83A226127DEC557500C3E574BC60125A9DC21CB0BE4A00660953033A1053103020102A203020103A30402020100A5053103020104AA03020101BF837803020117BF83790302011EBF853E03020100301F0603551D230418301680143FFCACD61AB13A9E8120B8D5251CC565BB1E91A9300A06082A8648CE3D0403020348003045022067773908938055FD634EE413EAAFC21D8AC7A9441BDF97AF63914F9B3B00AFFE022100B9C0C89458C2528E2B25FA88C4D63DDC75E1BC80FB94DCC6228952D04F81241859027C308202783082021EA00302010202021001300A06082A8648CE3D040302308198310B30090603550406130255533113301106035504080C0A43616C69666F726E69613116301406035504070C0D4D6F756E7461696E205669657731153013060355040A0C0C476F6F676C652C20496E632E3110300E060355040B0C07416E64726F69643133303106035504030C2A416E64726F6964204B657973746F726520536F667477617265204174746573746174696F6E20526F6F74301E170D3136303131313030343630395A170D3236303130383030343630395A308188310B30090603550406130255533113301106035504080C0A43616C69666F726E696131153013060355040A0C0C476F6F676C652C20496E632E3110300E060355040B0C07416E64726F6964313B303906035504030C32416E64726F6964204B657973746F726520536F667477617265204174746573746174696F6E20496E7465726D6564696174653059301306072A8648CE3D020106082A8648CE3D03010703420004EB9E79F8426359ACCB2A914C8986CC70AD90669382A9732613FEACCBF821274C2174974A2AFEA5B94D7F66D4E065106635BC53B7A0A3A671583EDB3E11AE1014A3663064301D0603551D0E041604143FFCACD61AB13A9E8120B8D5251CC565BB1E91A9301F0603551D23041830168014C8ADE9774C45C3A3CF0D1610E479433A215A30CF30120603551D130101FF040830060101FF020100300E0603551D0F0101FF040403020284300A06082A8648CE3D040302034800304502204B8A9B7BEE82BCC03387AE2FC08998B4DDC38DAB272A459F690CC7C392D40F8E022100EEDA015DB6F432E9D4843B624C9404EF3A7CCCBD5EFB22BBE7FEB9773F593FFB59028F3082028B30820232A003020102020900A2059ED10E435B57300A06082A8648CE3D040302308198310B30090603550406130255533113301106035504080C0A43616C69666F726E69613116301406035504070C0D4D6F756E7461696E205669657731153013060355040A0C0C476F6F676C652C20496E632E3110300E060355040B0C07416E64726F69643133303106035504030C2A416E64726F6964204B657973746F726520536F667477617265204174746573746174696F6E20526F6F74301E170D3136303131313030343335305A170D3336303130363030343335305A308198310B30090603550406130255533113301106035504080C0A43616C69666F726E69613116301406035504070C0D4D6F756E7461696E205669657731153013060355040A0C0C476F6F676C652C20496E632E3110300E060355040B0C07416E64726F69643133303106035504030C2A416E64726F6964204B657973746F726520536F667477617265204174746573746174696F6E20526F6F743059301306072A8648CE3D020106082A8648CE3D03010703420004EE5D5EC7E1C0DB6D03A67EE6B61BEC4D6A5D6A682E0FFF7F490E7D771F44226DBDB1AFFA16CBC7ADC577D2569CAAB7B02D54015D3E432B2A8ED74EEC487541A4A3633061301D0603551D0E04160414C8ADE9774C45C3A3CF0D1610E479433A215A30CF301F0603551D23041830168014C8ADE9774C45C3A3CF0D1610E479433A215A30CF300F0603551D130101FF040530030101FF300E0603551D0F0101FF040403020284300A06082A8648CE3D040302034700304402203521A3EF8B34461E9CD560F31D5889206ADCA36541F60D9ECE8A198C6648607B02204D0BF351D9307C7D5BDA35341DA8471B63A585653CAD4F24A7E74DAF417DF1BF68617574684461746158C59569088F1ECEE3232954035DBD10D7CAE391305A2751B559BB8FD7CBB229BDD4450000000028F37D2B92B841C4B02A860CEF7CC034004101552F0265F6E35BCC29877B64176690D59A61C3588684990898C544699139BE88E32810515987EA4F4833071B646780438BF858C36984E46E7708DEE61EEDCBD0A50102032620012158203849A20FDE26C34B0088391A5827783DFF93880B1654088AADFAF57A259549A1225820743C4B5245CF2685CF91054367CD4FAFB9484E70593651011FC0DCCE7621C68F");

    private static readonly byte[] FidoU2FAttestationObject = Convert.FromHexString(
        "A363666D74686669646F2D7532666761747453746D74A26373696758483046022100EFBAF3721226129D9943E655B42E619B29F25903ED825C2271D2DD039F6EB8A8022100CE0309E3DF5C05CCC1C3CDBAAF59B9E4999DF664F87758845D84BC15B227F0CA6378356381590248308202443082012EA00302010202045562BEA0300B06092A864886F70D01010B302E312C302A0603550403132359756269636F2055324620526F6F742043412053657269616C203435373230303633313020170D3134303830313030303030305A180F32303530303930343030303030305A302A3128302606035504030C1F59756269636F205532462045452053657269616C20313433323533343638383059301306072A8648CE3D020106082A8648CE3D030107034200044B331F773D8144B9995CBE4585517E17583AA47623695CBE85AC482C8019F2C9B9467AE045B0E66F131B2EA3243C91FDA602E318F3FC5D8D2A7ABAE72BD14309A33B3039302206092B0601040182C40A020415312E332E362E312E342E312E34313438322E312E353013060B2B0601040182E51C020101040403020520300B06092A864886F70D01010B0382010100AC16D9B36EB6B3A9B76D7594B34F59F4F73EDBC9FDEB2935EB6B451CABF41D25D3E71614D7472604CA72A578E323EDB76004685F05E7D1B9BE05DB6E9440FAC5CFC932A6CAFAE85299772EDB027820203CD4141D3EEB6F6A2CE99E3957803263ABAB8D6EC480A7DF084AD2CBA7B7D6D77C94C3EBC0B166F96057CAF5FE3A631EA26A433762A36FBECF4CF44509625FD5AF1049AA7C8BC7689A6659E9AF5DE8F0D72C28825174C50E06AB7F6A0790837B6DB32ABFDCBCA835CBBB090EF1F0D99E0869BFE9E56764C4230E6C057729B010DE0EC5F9CCE4C91C2826218EA8081ABB969151EC16725AF2A8D95E7795BCAA227A9B944320C427619CAAF854D98298D768617574684461746158C449960DE5880E8C687434170F6476605B8FE4AEB9A28632C7995CF3BA831D97634100000000000000000000000000000000000000000040068F958C73A4259CBC0E39C226721CD0EC6DF50033E6EA4C75227135B77E1B2028E8C348BCF05BF58B14944D1925A6965ED587E454323D2E9B4FF7BAF7C222ADA50102032620012158203573D008787E6C37AC7543EDAA47BBF6E79B647866D6B34102083C37E642460422582018D3531AEE69D8C514C9D6951E6B3C9AF6DEC0494FDA9EC58F4F09CF68F21993");

    private static readonly byte[] AppleAttestationObject = Convert.FromHexString(
        "A363666D74656170706C656761747453746D74A263616C6726637835638259024730820243308201C9A00302010202060176A070212B300A06082A8648CE3D0403023048311C301A06035504030C134170706C6520576562417574686E204341203131133011060355040A0C0A4170706C6520496E632E3113301106035504080C0A43616C69666F726E6961301E170D3230313232353139303433315A170D3230313232383139303433315A3081913149304706035504030C4034626236363866346435366539366666343035373431386139616665336536326634396139613234353238633035353865393164303630643734326530343665311A3018060355040B0C114141412043657274696669636174696F6E31133011060355040A0C0A4170706C6520496E632E3113301106035504080C0A43616C69666F726E69613059301306072A8648CE3D020106082A8648CE3D030107034200047A2709D531CB34574F4DAA760B62A01028640B4853E31D285322CB82D2A0443A17E200197D2064B08E7FBE65ECF44AD7E51DC9FC2A0C60583048F2E53B399949A3553053300C0603551D130101FF04023000300E0603551D0F0101FF0404030204F0303306092A864886F76364080204263024A12204205CDB9D907340455B6373E6752B73FC368453602215FAEABB7C165F0BADAC07CC300A06082A8648CE3D040302036800306502310091B96F26C1D062597E7436901B4FF02B5D1AAEFD1E14D67C35AA807DF9F701286DFB6CB24B4B35071F779A0E7F55A6030230296E88A95987071108C9088697A8C216598A62895B09FA5D63D261A92FB2D4720C7F77E41B4C0804A86FDDD1894A4E4C59023830820234308201BAA003020102021056255395C7A7FB40EBE228D8260853B6300A06082A8648CE3D040303304B311F301D06035504030C164170706C6520576562417574686E20526F6F7420434131133011060355040A0C0A4170706C6520496E632E3113301106035504080C0A43616C69666F726E6961301E170D3230303331383138333830315A170D3330303331333030303030305A3048311C301A06035504030C134170706C6520576562417574686E204341203131133011060355040A0C0A4170706C6520496E632E3113301106035504080C0A43616C69666F726E69613076301006072A8648CE3D020106052B8104002203620004832E872F261491810225B9F5FCD6BB6378B5F55F3FCB045BC735993475FD549044DF9BFE19211765C69A1DDA050B38D45083401A434FB24D112D56C3E1CFBFCB9891FEC0696081BEF96CBC77C88DDDAF46A5AEE1DD515B5AFAAB93BE9C0B2691A366306430120603551D130101FF040830060101FF020100301F0603551D2304183016801426D764D9C578C25A67D1A7DE6B12D01B63F1C6D7301D0603551D0E04160414EBAE82C4FFA1AC5B51D4CF24610500BE63BD7788300E0603551D0F0101FF040403020106300A06082A8648CE3D0403030368003065023100DD8B1A3481A5FAD9DBB4E7657B841E144C27B75B876A4186C2B1475750337227EFE554457EF648950C632E5C483E70C102302C8A6044DC201FCFE59BC34D2930C1487851D960ED6A75F1EB4ACABE38CD25B897D0C805BEF0C7F78B07A571C6E80E076861757468446174615898CC750CF9F5DEF1F3D373B21074053CC61A2746665E0F39D1A89A9E71D551714345000000000000000000000000000000000000000000146195664C0E93C68360969A42C5FB224871D6CDB4A50102032620012158207A2709D531CB34574F4DAA760B62A01028640B4853E31D285322CB82D2A0443A22582017E200197D2064B08E7FBE65ECF44AD7E51DC9FC2A0C60583048F2E53B399949");


    private readonly DefaultAttestationObjectDecoder _decoder = new(
        new DefaultCborDecoder(NullLogger<DefaultCborDecoder>.Instance),
        new DefaultAttestationStatementDecoder(
            new DefaultPackedAttestationStatementDecoder(NullLogger<DefaultPackedAttestationStatementDecoder>.Instance),
            new DefaultTpmAttestationStatementDecoder(NullLogger<DefaultTpmAttestationStatementDecoder>.Instance),
            new DefaultAndroidKeyAttestationStatementDecoder(NullLogger<DefaultAndroidKeyAttestationStatementDecoder>.Instance),
            new DefaultAndroidSafetyNetAttestationStatementDecoder(NullLogger<DefaultAndroidSafetyNetAttestationStatementDecoder>.Instance),
            new DefaultFidoU2FAttestationStatementDecoder(NullLogger<DefaultFidoU2FAttestationStatementDecoder>.Instance),
            new DefaultNoneAttestationStatementDecoder(NullLogger<DefaultNoneAttestationStatementDecoder>.Instance),
            new DefaultAppleAnonymousAttestationStatementDecoder(NullLogger<DefaultAppleAnonymousAttestationStatementDecoder>.Instance)),
        new DefaultAuthenticatorDataDecoder(
            new DefaultCoseKeyDecoder(
                new DefaultCborDecoder(
                    NullLogger<DefaultCborDecoder>.Instance),
                NullLogger<DefaultCoseKeyDecoder>.Instance),
            NullLogger<DefaultAuthenticatorDataDecoder>.Instance),
        NullLogger<DefaultAttestationObjectDecoder>.Instance);

    [Test]
    public async Task CanDecode_Packed_WithClientData()
    {
        var result = _decoder.Decode(PackedAttestationObject);
        if (result.HasError)
        {
            throw new InvalidOperationException();
        }

        //var ver = new DefaultAttestationStatementVerifier<TestWebAuthnContext>(new DefaultTimeProvider(), NullLogger<DefaultAttestationStatementVerifier<TestWebAuthnContext>>.Instance);
        var ver = new DefaultAttestationStatementVerifier<TestWebAuthnContext>(
            new DefaultPackedAttestationStatementVerifier(new DefaultTimeProvider(), new DefaultDigitalSignatureVerifier()),
            new DefaultTpmAttestationStatementVerifier(),
            new DefaultAndroidKeyAttestationStatementVerifier(),
            new DefaultAndroidSafetyNetAttestationStatementVerifier(),
            new DefaultFidoU2FAttestationStatementVerifier(),
            new DefaultNoneAttestationStatementVerifier(),
            new DefaultAppleAnonymousAttestationStatementVerifier(),
            NullLogger<DefaultAttestationStatementVerifier<TestWebAuthnContext>>.Instance
        );
        await using var ctx = new TestWebAuthnContext(null);
        await ver.VerifyAttestationStatementAsync(ctx, new(
                AttestationStatementFormat.Packed,
                result.Ok.AttStmt,
                new(
                    result.Ok.AuthData.RpIdHash,
                    result.Ok.AuthData.Flags,
                    result.Ok.AuthData.SignCount,
                    result.Ok.AuthData.AttestedCredentialData!,
                    result.Ok.RawAuthData),
                SHA256.HashData(WebEncoders.Base64UrlDecode(
                    "eyJ0eXBlIjoid2ViYXV0aG4uY3JlYXRlIiwiY2hhbGxlbmdlIjoiXzQwblgweWFLanNHMGprbUxrVXBrLTBPY2xKSVF6bGhVcW5aRkp1MUgyQSIsIm9yaWdpbiI6Imh0dHBzOi8vbG9jYWxob3N0OjUwMDEiLCJjcm9zc09yaWdpbiI6ZmFsc2UsIm90aGVyX2tleXNfY2FuX2JlX2FkZGVkX2hlcmUiOiJkbyBub3QgY29tcGFyZSBjbGllbnREYXRhSlNPTiBhZ2FpbnN0IGEgdGVtcGxhdGUuIFNlZSBodHRwczovL2dvby5nbC95YWJQZXgifQ"))),
            default);
        Assert.That(result.HasError, Is.False);
        Assert.That(result.Ok!.Fmt, Is.EqualTo(AttestationStatementFormat.Packed));
    }

    [Test]
    public void CanDecode_Packed()
    {
        var result = _decoder.Decode(PackedAttestationObject);
        Assert.That(result.HasError, Is.False);
        Assert.That(result.Ok!.Fmt, Is.EqualTo(AttestationStatementFormat.Packed));
    }

    [Test]
    public void CanDecode_None()
    {
        var result = _decoder.Decode(NoneAttestationObject);
        Assert.That(result.HasError, Is.False);
        Assert.That(result.Ok!.Fmt, Is.EqualTo(AttestationStatementFormat.None));
    }

    [Test]
    public void CanDecode_Tpm()
    {
        var result = _decoder.Decode(TpmAttestationObject);
        Assert.That(result.HasError, Is.False);
        Assert.That(result.Ok!.Fmt, Is.EqualTo(AttestationStatementFormat.Tpm));
    }

    [Test]
    public async Task CanDecode_Tpm_RsaSha1_WithClientData()
    {
        var result = _decoder.Decode(WebEncoders.Base64UrlDecode(
            "o2NmbXRjdHBtZ2F0dFN0bXSmY2FsZzn__mNzaWdZAQBIwu9LPAl-LgxlRzPlvn7L-0yuMnFFn1XALxXtGnmC5-oMIIqfUJWFbgBbkN2l2zPsqOCRT5GQU8ucKNI6HrlbuDAUIq7wjcxG5TzgQt3YtGMWtgEcrZn2ecUlQFKjY67_wZIuHLy443Ki1SjErNPrMrkIPe9lyFhIalMgrWLCol40gYIVr_9xLfgyX55c7XiB-XbUKhDLUv5uPA3CSAiWeWwWx26K2BTV85vHsaG6f2YFTfcQTFs1cTSwMm7A9C2SiQ7N01ENwM1urVxlCvuEsBgiXapR70Oyq_cfiENYY0ti7_w2fvikmfv0z0O1cJOAyUlYWjnWhT707chrVmkFY3ZlcmMyLjBjeDVjglkEXzCCBFswggNDoAMCAQICDwRsOt2imXnV5Z4BftcqfzANBgkqhkiG9w0BAQsFADBBMT8wPQYDVQQDEzZOQ1UtTlRDLUtFWUlELTM2MTA0Q0U0MEJCQ0MxRjQwRDg0QTRCQkQ1MEJFOTkwMjREOTU3RDQwHhcNMTgwMjAxMDAwMDAwWhcNMjUwMTMxMjM1OTU5WjAAMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAmw-4ficURR_sgVfW7cs1iRoDGdxjBpCczF233ba_5WTP-RrsYZPlzWgSN9WXptuywzjZoDlbid7NlduSR1ZFsds4bW71LyKDL62eyqaiAc645gocXAyxdDIDJAeo-3N9Dm4vsw-Gy_0sd2v1UEkBhWjuE1gL5hcaB9EtXSDvHPwmrf0eYn_4cWu9AxqSxpn79JIPYEOUrURr2H8zyG4_P0j1a3MVBmtAymhpXBn9ila-bW7K_k0JYXBh5yAYZDsmHgFsXbUauDWdja3HYzkep9jXkFcegXOMjPr_QSqWRjawEvzoprnJ-QqoWNbaRhuD-UnfgCNbwseU8kZ0aQNjBQIDAQABo4IBjzCCAYswDgYDVR0PAQH_BAQDAgeAMAwGA1UdEwEB_wQCMAAwUwYDVR0gAQH_BEkwRzBFBgkrBgEEAYI3FR8wODA2BggrBgEFBQcCAjAqEyhGQUtFIEZJRE8gVENQQSBUcnVzdGVkIFBsYXRmb3JtIElkZW50aXR5MBAGA1UdJQQJMAcGBWeBBQgDMEoGA1UdEQEB_wRAMD6kPDA6MTgwDgYFZ4EFAgMMBWlkOjEzMBAGBWeBBQICDAdOUENUNnh4MBQGBWeBBQIBDAtpZDpGRkZGRjFEMDAfBgNVHSMEGDAWoBRRfyLI5lOlfNVM3TBYfjD_ZzaMXTAdBgNVHQ4EFgQUO6SUmiOhCHVZcq-88acg2uQkQz8weAYIKwYBBQUHAQEEbDBqMGgGCCsGAQUFBzAChlxodHRwczovL2ZpZG9hbGxpYW5jZS5jby5uei90cG1wa2kvTkNVLU5UQy1LRVlJRC0zNjEwNENFNDBCQkNDMUY0MEQ4NEE0QkJENTBCRTk5MDI0RDk1N0Q0LmNydDANBgkqhkiG9w0BAQsFAAOCAQEAIIyVBkck_SD2nbj4KOwUI6cYZHrjwrcULoEiOSXn9TjTIiB5MdBMvqqNyAXiyWoWd1GEc_MI3mKOzu4g5UTVQQqfiOTrqfuZrpoU0tAeojKnZLj2wYj5GpyOfEkPK3m9qVaDxiYrh6aS8a3w_Iog878EiIaoVALbBt5uAfh0TAHHwSdxHtU8DRJrC43yIqcP9byRqssJmgSNcpMAjw_hcKJxDMD2UurvsMasqyWvK533yNA0-VwXvk3HI0ItSOw_g352D-qOTHI82lJIjc3yKoaNeYKn7RzgcLAF7AesTiiJReY2kU_vLyf-wH54-08T3oyBBJpBCHc1y_Lt5d2qWFkGCDCCBgQwggPsoAMCAQICENBTpEeEh5lpTgeR7VT9oQcwDQYJKoZIhvcNAQELBQAwgb8xCzAJBgNVBAYTAlVTMQswCQYDVQQIDAJNWTESMBAGA1UEBwwJV2FrZWZpZWxkMRYwFAYDVQQKDA1GSURPIEFsbGlhbmNlMQwwCgYDVQQLDANDV0cxNjA0BgNVBAMMLUZJRE8gRmFrZSBUUE0gUm9vdCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkgMjAxODExMC8GCSqGSIb3DQEJARYiY29uZm9ybWFuY2UtdG9vbHNAZmlkb2FsbGlhbmNlLm9yZzAeFw0xNzAyMDEwMDAwMDBaFw0zNTAxMzEyMzU5NTlaMEExPzA9BgNVBAMTNk5DVS1OVEMtS0VZSUQtMzYxMDRDRTQwQkJDQzFGNDBEODRBNEJCRDUwQkU5OTAyNEQ5NTdENDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBANc-c30RpQd-_LCoiLJbXz3t_vqciOIovwjez79_DtVgi8G9Ph-tPL-lC0ueFGBMSPcKd_RDdSFe2QCYQd9e0DtiFxra-uWGa0olI1hHI7bK2GzNAZSTKEbwgqpf8vXMQ-7SPajg6PfxSOLH_Nj2yd6tkNkUSdlGtWfY8XGB3n-q--nt3UHdUQWEtgUoTe5abBXsG7MQSuTNoad3v6vk-tLd0W44ivM6pbFqFUHchx8mGLApCpjlVXrfROaCoc9E91hG9B-WNvekJ0dM6kJ658Hy7yscQ6JdqIEolYojCtWaWNmwcfv--OE1Ax_4Ub24gl3hpB9EOcBCzpb4UFmLYUECAwEAAaOCAXcwggFzMAsGA1UdDwQEAwIBhjAWBgNVHSAEDzANMAsGCSsGAQQBgjcVHzAbBgNVHSUEFDASBgkrBgEEAYI3FSQGBWeBBQgDMBIGA1UdEwEB_wQIMAYBAf8CAQAwHwYDVR0OBBgEFsIUUX8iyOZTpXzVTN0wWH4w_2c2jF0wHwYDVR0jBBgwFqAUXH82LZCtWry6jnXa3jqg7cFOAoswaAYDVR0fBGEwXzBdoFugWYZXaHR0cHM6Ly9maWRvYWxsaWFuY2UuY28ubnovdHBtcGtpL2NybC9GSURPIEZha2UgVFBNIFJvb3QgQ2VydGlmaWNhdGUgQXV0aG9yaXR5IDIwMTguY3JsMG8GCCsGAQUFBwEBBGMwYTBfBggrBgEFBQcwAoZTaHR0cHM6Ly9maWRvYWxsaWFuY2UuY28ubnovdHBtcGtpL0ZJRE8gRmFrZSBUUE0gUm9vdCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkgMjAxOC5jcnQwDQYJKoZIhvcNAQELBQADggIBAG138t55DF9nPJbvbPQZOypmyTPpNne0A5fh69P1fHZ5qdE2PDz3cf5Tl-8OPI4xQniEFNPcXMb7KlhMM6zCl4GkZtNN4MxygdFjQ1gTZOBDpt7Dwziij0MakmwyC0RYTNtbSyVhHUevgw9rnu13EzqxPyL5JD-UqADh2Y51MS0qy7IOgegLQv-eJzSNUgHxFJreUzz4PU6yzSsTyyYDW-H4ZjAQKienVp8ewZf8oHGWHGQFGa5E9m1P8vxCMZ7pIzeQweCVYrs3q7unu4nzBAIXLPI092kYFUgyz3lIaSB3XEiPBokpupX6Zmgrfphb-XX3tbenH5hkxfumueA5RMHTMu5TVjhJXiV0yM3q5W5xrQHdJlF5nOdJDEE-Kb7nm6xaT1DDpafqBc5vEDMkJmBA4AXHUY7JPGqEEzEenT7k6Wn5IQLZg4qc8Irnj__yM7xUhJWJam47KVbLA4WFu-IKvJrkP5GSglZ9qASOCxBHaOL2UcTAg50uvhUSwur2KSak2vlENdmAijwdAL4LLQWrkFd-9NBwcNwTdfK4ekEHP1l4BwJtkNwW6etUgeA5rkW2JLocXoBq5v7GSk4_CBoKhyiahQGQQ9SZFGeBJhzzkK9yN-yKskcVjjjInSHPl-ZpeOK3sI08sEyTH0gxlTtRoX0MKDsMAHEVToe5o1u9Z3B1YkFyZWFZATYAAQALAAYEcgAgnf_L82w4OuaZ-5ho3G3LidcVOIS-KAOSLBJBWL-tIq4AEAAQCAAAAAAAAQCl9siJwqoHJ2pCwEKyLQ_u6zGcZDKZtA0jtvtn1aPlIe7wFAvQNgjI6KDiQsDPTCVeJj_RA441VbV0Z4oX2b68quDY0Gf4VpF4KWfNPdKH6H4E882m8OnBb10mhaNbPxTmDVDZLQZjh3ubX1Z56FNg6cQmz4bEnHF-7X1l7AcNORhzdzgM7uRXhwo9UsAzpu4Io1OCTsb5DaDnng3f3Y9qDn8OG3MI_5IYtm1qGgmY72nSEiIhhPCk2lvmajN6A4tWgUstc7QtdlKEPBd-ITtGdKYTSwqihaHzBQd8D-d_HDqgcOWECLKo51_YqyaEiuGlv6sPon1LMsEL6PlVw47PaGNlcnRJbmZvWKH_VENHgBcAIgALEeaO1E21Ny4UKW4vhKzHg5h1GIGSHjD8IqBvi3PHlFMAFF6MXAvgUX_Rbc04fmdB2TyLG-mdAAAAAUdwF0hVaXtLxoVgpQFzfvmNNFZV-wAiAAuYlrm-5Jg3251TsEdZ8NV11xd4X5O3q0AFLmammw658QAiAAtuzX-04mcxAHq9kO70Ew3vJCOmCS0UvQzZB2CNCeGXpWhhdXRoRGF0YVkBZ0mWDeWIDoxodDQXD2R2YFuP5K65ooYyx5lc87qDHZdjQQAAAHXyRLZ-U2RP1Z-Qw5YicxfbACBQkOhQmgaINAX8QRncb_P0t-rXr8oVpe0xOPBNSutGV6QBAwM5__4gWQEApfbIicKqBydqQsBCsi0P7usxnGQymbQNI7b7Z9Wj5SHu8BQL0DYIyOig4kLAz0wlXiY_0QOONVW1dGeKF9m-vKrg2NBn-FaReClnzT3Sh-h-BPPNpvDpwW9dJoWjWz8U5g1Q2S0GY4d7m19WeehTYOnEJs-GxJxxfu19ZewHDTkYc3c4DO7kV4cKPVLAM6buCKNTgk7G-Q2g554N392Pag5_DhtzCP-SGLZtahoJmO9p0hIiIYTwpNpb5mozegOLVoFLLXO0LXZShDwXfiE7RnSmE0sKooWh8wUHfA_nfxw6oHDlhAiyqOdf2KsmhIrhpb-rD6J9SzLBC-j5VcOOzyFDAQAB"));
        if (result.HasError)
        {
            throw new InvalidOperationException();
        }

        //var ver = new DefaultAttestationStatementVerifier<TestWebAuthnContext>(new DefaultTimeProvider(), NullLogger<DefaultAttestationStatementVerifier<TestWebAuthnContext>>.Instance);
        var ver = new DefaultAttestationStatementVerifier<TestWebAuthnContext>(
            new DefaultPackedAttestationStatementVerifier(new DefaultTimeProvider(), new DefaultDigitalSignatureVerifier()),
            new DefaultTpmAttestationStatementVerifier(),
            new DefaultAndroidKeyAttestationStatementVerifier(),
            new DefaultAndroidSafetyNetAttestationStatementVerifier(),
            new DefaultFidoU2FAttestationStatementVerifier(),
            new DefaultNoneAttestationStatementVerifier(),
            new DefaultAppleAnonymousAttestationStatementVerifier(),
            NullLogger<DefaultAttestationStatementVerifier<TestWebAuthnContext>>.Instance
        );
        await using var ctx = new TestWebAuthnContext(null);
        await ver.VerifyAttestationStatementAsync(ctx, new(
                AttestationStatementFormat.Tpm,
                result.Ok.AttStmt,
                new(
                    result.Ok.AuthData.RpIdHash,
                    result.Ok.AuthData.Flags,
                    result.Ok.AuthData.SignCount,
                    result.Ok.AuthData.AttestedCredentialData!,
                    result.Ok.RawAuthData),
                SHA256.HashData(WebEncoders.Base64UrlDecode(
                    "eyJvcmlnaW4iOiJodHRwczovL2xvY2FsaG9zdDo0NDMyOSIsImNoYWxsZW5nZSI6IjlKeVVmSmtnOFBxb0tadUQ3Rkh6T0U5ZGJ5Y3VsQzl1ckdUcEdxQm5Fd25oS21uaTRyR1JYeG0zLVpCSEs4eDZyaUpRcUlwQzhxRWEtVDBxSUZUS1RRIiwidHlwZSI6IndlYmF1dGhuLmNyZWF0ZSJ9"))),
            default);

        Assert.That(result.HasError, Is.False);
        Assert.That(result.Ok!.Fmt, Is.EqualTo(AttestationStatementFormat.Tpm));
    }

    [Test]
    public async Task CanDecode_Tpm_ECC_WithClientData()
    {
        var result = _decoder.Decode(WebEncoders.Base64UrlDecode(
            "o2NmbXRjdHBtZ2F0dFN0bXSmY2FsZzn__mNzaWdZAQAzaz3HmrpCUlkEV2iv-TF2_y0MD7MVc0rLyuD_Ah3X9vx3G21WgeI89PyyvEYw3yEUUdO7sn6YxubMfuePpuSawYKAeSbw3O4LkMDC2fqZmlLyTfoC8L1_8vExv6mWPN7H5U6E_K7IZ38H3mO736ie-mDyoXxalj4WkA9zjKXJM5t7GhHQAqtDaX4HmM47pFH25atgQnoLdB0MTzh6jgYjIiDrMSOqhrQYskiaX_LFfKTiWfviwMOYcMA8FkRPc05LKvPTxp-bx_ghHrd_gIAUA3MjfElVYCVfveMnI61ZwARnf0cTrFp7vfga85YeAXaLOu29JifjodW6DsjL_dnXY3ZlcmMyLjBjeDVjglkFtTCCBbEwggOZoAMCAQICEAaSyUKea0mgpfZbwvZ7byMwDQYJKoZIhvcNAQELBQAwQTE_MD0GA1UEAxM2RVVTLU5UQy1LRVlJRC0yM0Y0RTIyQUQzQkUzNzRBNDQ5NzcyOTU0QUEyODNBRUQ3NTI1NzJFMB4XDTIxMTEyNTIxMzA1NFoXDTI3MDYwMzE3NTE0N1owADCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBANwiGFmQdIOYto4qGegANWT-LdSr5T5_tj7E_aKtLSNP8bqc6eP11VvCi9ZFnbjiFxi1NdY2GAbUDb3zr1PnZpOcwvn1gh704PLtkZYFkwvFRvm5bIvtsuqYgn71MCup1GCTeJ3EcylidbVpmwX5s9XK5vyRsMpQ1TxPwxPq32toIBcQ3pgZyb9Ic_m1IfWE_hC_XlwZzqfFnFL7XszCGwJmziFjML9VeBrdv0dkrDWMv1sNI1PDDm_JQ8iZwZ83At3qsgnmwN4zudOMUPRMJBNeiVBj9GjW7tV9tSG2Oa_F_JUo0b1Gr_y08PSMhAckj6ZaR8_EBppoty9CbTm65nsCAwEAAaOCAeQwggHgMA4GA1UdDwEB_wQEAwIHgDAMBgNVHRMBAf8EAjAAMG0GA1UdIAEB_wRjMGEwXwYJKwYBBAGCNxUfMFIwUAYIKwYBBQUHAgIwRB5CAFQAQwBQAEEAIAAgAFQAcgB1AHMAdABlAGQAIAAgAFAAbABhAHQAZgBvAHIAbQAgACAASQBkAGUAbgB0AGkAdAB5MBAGA1UdJQQJMAcGBWeBBQgDMEoGA1UdEQEB_wRAMD6kPDA6MTgwDgYFZ4EFAgMMBWlkOjcyMBAGBWeBBQICDAdOUENUNzV4MBQGBWeBBQIBDAtpZDo0RTU0NDMwMDAfBgNVHSMEGDAWgBTTjd-fy_wwa14b1TQrBpJk2U7fpTAdBgNVHQ4EFgQUeq9wlX_04m4THgx-yMSO7QwViv8wgbIGCCsGAQUFBwEBBIGlMIGiMIGfBggrBgEFBQcwAoaBkmh0dHA6Ly9hemNzcHJvZGV1c2Fpa3B1Ymxpc2guYmxvYi5jb3JlLndpbmRvd3MubmV0L2V1cy1udGMta2V5aWQtMjNmNGUyMmFkM2JlMzc0YTQ0OTc3Mjk1NGFhMjgzYWVkNzUyNTcyZS8xMzY0YTJkMy1hZTU0LTQ3YjktODdmMy0zMjA1NDE5NDc0MGUuY2VyMA0GCSqGSIb3DQEBCwUAA4ICAQCiPgQwqysYPQpMiRDpxbsx24d1xVX_kiUwwcQJE3mSYvwe4tnaQSHjlfB3OkpDMjotxFl33oUMxxScjSrgp_1o6rdkiO6QvPMgsqDMX4w-dmWn00akwNbMasTxg39Ceqtocw4i-R9AlNwndpe3QUIt8xkQ5dhlcIF8lc1dXmgz4mkMAtOi3VgaNvHTsRF9pLbTczJss608X8b4gHqM4t7lfIcRB8DvSyfXc7T3k21-4_3jvAb2HRoCCAyv8_XXn1UwkWTrXMLUSiE1p5Sl8ba8I_86Hsemsc0aflwRZrrY2pC3aaA3QbbfAyskiaFPw-ZibY9p0_QVq1XhAKa-dDd70mWvTGKQdrqfZI_SC5zccvDAm6aefAfnYBY2fV92ZFriihA2ULcJaESz3X3JkiK4eO1k0T2uf9-rL4lUEADibwpnsZOBeNWBsztvXDmcZGR_MSoRIQygKMw2U7AproqBPDRDFwhS5yc9UHvD6dMZ3PLx4i_eo-BLr-QJ2HARoyK8KuV0xLEq3XyjWdfZDbAueUVgtic14wK9jiSbhycRT2WV3-QU8KPm5_QCt_eBPwY81a-q84jm2ue_ok8-LYrmWpvihqRhFhK9MLVS96QaHeeuDehYNDWsSIVCr9jB-lchueZ-kZqwyl_4pPMrM7wLXBOR-bV5_pAPv3u_RvQmhVkG7zCCBuswggTToAMCAQICEzMAAAQHrjuoB9SvW8wAAAAABAcwDQYJKoZIhvcNAQELBQAwgYwxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpXYXNoaW5ndG9uMRAwDgYDVQQHEwdSZWRtb25kMR4wHAYDVQQKExVNaWNyb3NvZnQgQ29ycG9yYXRpb24xNjA0BgNVBAMTLU1pY3Jvc29mdCBUUE0gUm9vdCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkgMjAxNDAeFw0yMTA2MDMxNzUxNDdaFw0yNzA2MDMxNzUxNDdaMEExPzA9BgNVBAMTNkVVUy1OVEMtS0VZSUQtMjNGNEUyMkFEM0JFMzc0QTQ0OTc3Mjk1NEFBMjgzQUVENzUyNTcyRTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAMkPU9X8JhPBwDxmFm84D31b8xN5NQz0XR8Nji_-Z8v3WtC4lSdEwJUwqvZkj5OQ3wPA_6haONcCHzqTZhyz1aheOPhXmEeWFWjEiJFj07crEZb9wM4rM1fdcf3vCQNSSDlogC5AM-tITx31hm0YffIrzM3n70fNBBfvlw8t-yhZVOavj7l29gKsyvkR0IadruvLVWWVeH9rueHVrOwlU4wUJpjD41d4U87M3FgUGK2YacQxT0BPHzaOCTE9YhylG5fA_eCF7Q1SxAe347uIaS6I3GhAootzJy9XYeFp_uhc1Yp2hMh5wdeRkm15WKb7tE9T4vwHp0VCQEkUQn1ClN_s7PpfKNFp-DB9ez0Fh7tqag6AssrKE6LgOjfWDWUcgzgIiFLvv9Gx797IZj8LDazK1iGSqI2D8zmmxnGG47MevfY8q2udJW1G4nOcjw49x6XZHmnT3VpVKcTDbI9bEsyc2R9vngftF9FgnEVdyt-QRqE0UqEXJmjLhcxBMeyFZJd_bEAutSBpWugPk10IPFRkXppsuHMZFHJVP96IWwVmm6Q4mX018K996XDubAGblbhvPzJ9NFL_e7xM2ev3rAalz2CzSLYs48EXym7dqGTnP7F9DaF2O0IHT0GQ951wFVoGmA-IYsTMVsdlhVaImCuHgahu1W94H6BvtDkGGku7AgMBAAGjggGOMIIBijAOBgNVHQ8BAf8EBAMCAoQwGwYDVR0lBBQwEgYJKwYBBAGCNxUkBgVngQUIAzAWBgNVHSAEDzANMAsGCSsGAQQBgjcVHzASBgNVHRMBAf8ECDAGAQH_AgEAMB0GA1UdDgQWBBTTjd-fy_wwa14b1TQrBpJk2U7fpTAfBgNVHSMEGDAWgBR6jArOL0hiF-KU0a5VwVLscXSkVjBwBgNVHR8EaTBnMGWgY6Bhhl9odHRwOi8vd3d3Lm1pY3Jvc29mdC5jb20vcGtpb3BzL2NybC9NaWNyb3NvZnQlMjBUUE0lMjBSb290JTIwQ2VydGlmaWNhdGUlMjBBdXRob3JpdHklMjAyMDE0LmNybDB9BggrBgEFBQcBAQRxMG8wbQYIKwYBBQUHMAKGYWh0dHA6Ly93d3cubWljcm9zb2Z0LmNvbS9wa2lvcHMvY2VydHMvTWljcm9zb2Z0JTIwVFBNJTIwUm9vdCUyMENlcnRpZmljYXRlJTIwQXV0aG9yaXR5JTIwMjAxNC5jcnQwDQYJKoZIhvcNAQELBQADggIBAIQJqhFB71eZzZMq0w866QXDKlHcGyIa_IkTK4p5ejIdIA7FJ8neeVToAKUt9ULEb1Od2ir1y5Qx5Zp_edf4F8aikn-yw61hNB3FQ4iSV49eqEMe2Fx6OMBmHRWGtUjAlf5g_N2Qc6rHela2d69nQbpSF3Nq7AESguXxnoqZ-4CGUW0jC_b93sTd5fESHs_iwFX-zWKCwCXerqCuI3PqYWOlbCnftYhsI1CD638wJxw4YFXdSmOrF8dDnd6tlH_0qCZrBX-k4N-8QgK1-BDYIxmvUBnpLFDDitB2dP6YIglY0VcjkPd3BDmodHknG4GQeAvJKHpqF91Y3K1rOWvn4JqzHFvL3JgXgL7LbC_h9EF50HeHayPCToTS8Pmg_4dfUaCwNlxPvu9GvjrDKDNNEV5T73iWMV_GQbVsx6JULAljCthYLo-55mONDcr1x7kakXlQT-yIdIQ57Ix8eHz_qkJkvWxbw8vOgrXhkLK0jGAvW_YSkTV7G9_TYDJ--8IjPPHC1bexKq72-L7KetwH6LbWHGeYkJnaZ1zqeN4USxyJn8K4uhwnjSeK2sZ942zn5EnZnjd85yfdkPLcQY8xtYiWNjc_PprTrjhLyMO71VdMkTDiTTtDha37qywNISPV7vBv8YDiDjX8ElsWbTHTC0XgBp0h-RkjaRKI5C4eTUebZ3B1YkFyZWFYdgAjAAsABAByACCd_8vzbDg65pn7mGjcbcuJ1xU4hL4oA5IsEkFYv60irgAQABAAAwAQACCweOEk52r8mnJ6y9bsGcM3V4dL1LWt8I67Jjx5mcrFuAAgjwd_jaCEEOAJLV97kX3VgbxzopPYMC4NqEFjD0m55PpoY2VydEluZm9Yof9UQ0eAFwAiAAvgBLotxyAAbygBG4efe84V0SVYnO6xLrYaC1oyLgTt3QAUjcjAdORvuzxCfLBU7KNxPFSPE84AAAAUHn9jxccO2yRJARoXARNN0IPNWxnEACIACxfcHNQuRgb_05OKyBrS_1kY5IYxOl67gTlqkHd4g6slACIAC7tcXSHNTw8ANLeZd3PKooKsgrMIlGD47aunn05BcquwaGF1dGhEYXRhWKRqubvw35oW-R27M7uxMvr50Xx4LEgmxuxw7O5Y2X71KkUAAAAACJhwWMrcS4G24TDeUNy-lgAgBoLAd0jIDI0ztrH1N45XQ_0w_N5ndt3hpNixQi3J2NqlAQIDJiABIVggsHjhJOdq_JpyesvW7BnDN1eHS9S1rfCOuyY8eZnKxbgiWCCPB3-NoIQQ4AktX3uRfdWBvHOik9gwLg2oQWMPSbnk-g"));
        if (result.HasError)
        {
            throw new InvalidOperationException();
        }

        //var ver = new DefaultAttestationStatementVerifier<TestWebAuthnContext>(new DefaultTimeProvider(), NullLogger<DefaultAttestationStatementVerifier<TestWebAuthnContext>>.Instance);
        var ver = new DefaultAttestationStatementVerifier<TestWebAuthnContext>(
            new DefaultPackedAttestationStatementVerifier(new DefaultTimeProvider(), new DefaultDigitalSignatureVerifier()),
            new DefaultTpmAttestationStatementVerifier(),
            new DefaultAndroidKeyAttestationStatementVerifier(),
            new DefaultAndroidSafetyNetAttestationStatementVerifier(),
            new DefaultFidoU2FAttestationStatementVerifier(),
            new DefaultNoneAttestationStatementVerifier(),
            new DefaultAppleAnonymousAttestationStatementVerifier(),
            NullLogger<DefaultAttestationStatementVerifier<TestWebAuthnContext>>.Instance
        );
        await using var ctx = new TestWebAuthnContext(null);
        await ver.VerifyAttestationStatementAsync(ctx, new(
                AttestationStatementFormat.Tpm,
                result.Ok.AttStmt,
                new(
                    result.Ok.AuthData.RpIdHash,
                    result.Ok.AuthData.Flags,
                    result.Ok.AuthData.SignCount,
                    result.Ok.AuthData.AttestedCredentialData!,
                    result.Ok.RawAuthData),
                SHA256.HashData(WebEncoders.Base64UrlDecode(
                    "eyJ0eXBlIjoid2ViYXV0aG4uY3JlYXRlIiwiY2hhbGxlbmdlIjoiRTJZZWJNbUc5OTkyWGlhbHBGTDFsa1BwdE9JQlBlS3NwaE5rdDFKY2JLayIsIm9yaWdpbiI6Imh0dHBzOi8vd2ViYXV0aG4uZmlyc3R5ZWFyLmlkLmF1IiwiY3Jvc3NPcmlnaW4iOmZhbHNlLCJvdGhlcl9rZXlzX2Nhbl9iZV9hZGRlZF9oZXJlIjoiZG8gbm90IGNvbXBhcmUgY2xpZW50RGF0YUpTT04gYWdhaW5zdCBhIHRlbXBsYXRlLiBTZWUgaHR0cHM6Ly9nb28uZ2wveWFiUGV4In0"))),
            default);

        Assert.That(result.HasError, Is.False);
        Assert.That(result.Ok!.Fmt, Is.EqualTo(AttestationStatementFormat.Tpm));
    }

    [Test]
    public async Task CanDecode_Tpm_RsaSha256_WithClientData()
    {
        var result = _decoder.Decode(WebEncoders.Base64UrlDecode(
            "o2NmbXRjdHBtZ2F0dFN0bXSmY2FsZzkBAGNzaWdZAQA6Gh1Oa3-8vCY8bTrpUHA4zp4UCsbuh36tH09G-qWlvQdoqEQsJJQu1Rz61_mFes9CXE2cxiJV8pEwxtUUTSZQWnamVU1x9bBk07qcHqAuamP_NDAahHhZ9D46q9JklT3aVdhbaZVh0y5b8NZB2eUfKqcUmM0JCxLP9ZfSe7XcVguhQVEduM6Qnl9R1zRh7cquOa8UOEpdXkt1-drsOtrA9c0UJPYzkI8qscCDc-xfzo2xv12tLXjRq395JnynHhjzJIz8Ch2IYQUiMSM6TQDcnvzDEvRgril9NC0aIkHd79omIZNnBjEDfjyqOZbBffjGyvt1Eikz4M0EE8e7N4uRY3ZlcmMyLjBjeDVjglkEXzCCBFswggNDoAMCAQICDwQ_ozlil_l5hh6NlMsLzzANBgkqhkiG9w0BAQsFADBBMT8wPQYDVQQDEzZOQ1UtTlRDLUtFWUlELTM2MTA0Q0U0MEJCQ0MxRjQwRDg0QTRCQkQ1MEJFOTkwMjREOTU3RDQwHhcNMTgwMjAxMDAwMDAwWhcNMjUwMTMxMjM1OTU5WjAAMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAor_6-4WYizZdOQ9Ia_offaIdL2BVGtGDq8jQxo16ymBSOWCP15gZt9QAkqowS3ayqEh48Pg5SdA7F5kcjD_FqKaZDBOqkjvJivdo7FKv7EaUI2al9B7h0pXIRb97jn2z0zPlXz6RV_RmBe3CCljyxrhav7bTkCXEJUnkNgxsWgLGBIW6VSVct0z42xBB6_6mYekWIej5vXLqB8AuzsqnLbU5jOohfJiI5urFso12j6YCWZ_kXK4j8e4IoHUOjWgtHXdb3kP8PvI948hcJpIEpuuLDZDDOCOPI1wAlryGwz_tJLarODZzD1XhG3BMlXi1TG7x1s-AriC3A7B89wuSpwIDAQABo4IBjzCCAYswDgYDVR0PAQH_BAQDAgeAMAwGA1UdEwEB_wQCMAAwUwYDVR0gAQH_BEkwRzBFBgkrBgEEAYI3FR8wODA2BggrBgEFBQcCAjAqEyhGQUtFIEZJRE8gVENQQSBUcnVzdGVkIFBsYXRmb3JtIElkZW50aXR5MBAGA1UdJQQJMAcGBWeBBQgDMEoGA1UdEQEB_wRAMD6kPDA6MTgwDgYFZ4EFAgMMBWlkOjEzMBAGBWeBBQICDAdOUENUNnh4MBQGBWeBBQIBDAtpZDpGRkZGRjFEMDAfBgNVHSMEGDAWoBRRfyLI5lOlfNVM3TBYfjD_ZzaMXTAdBgNVHQ4EFgQUS1ZtGu6ZoewTH3mq04Ytxa4kOQcweAYIKwYBBQUHAQEEbDBqMGgGCCsGAQUFBzAChlxodHRwczovL2ZpZG9hbGxpYW5jZS5jby5uei90cG1wa2kvTkNVLU5UQy1LRVlJRC0zNjEwNENFNDBCQkNDMUY0MEQ4NEE0QkJENTBCRTk5MDI0RDk1N0Q0LmNydDANBgkqhkiG9w0BAQsFAAOCAQEAbp-Xp9W0vyY08YUHxerc6FnFdXZ6KFuQTZ4hze60BWexCSQOee25gqOoQaQr9ufS3ImLAoV4Ifc3vKVBQvBRwMjG3pJINoWr0p2McI0F2SNclH4M0sXFYHRlmHQ2phZB6Ddd-XL8PsGyiXRI6gVacVw5ZiVEBsRrekLH-Zy25EeqS3SxaBVnEd-HZ6BGGgbflgFtyGP9fQ5YSORC-Btno_uJbmRiZm4iHiEULp9wWEWOJIOXv9tVQKsYpPg58L1_Dgc8oml1YG5a8qK3jaR77tcUgZyYy5GOk1zIsXv36f0SkmLcNTiTjrhdGVcKs2KpW5fQgm_llQ5cvhR1jlY6dFkGCDCCBgQwggPsoAMCAQICENBTpEeEh5lpTgeR7VT9oQcwDQYJKoZIhvcNAQELBQAwgb8xCzAJBgNVBAYTAlVTMQswCQYDVQQIDAJNWTESMBAGA1UEBwwJV2FrZWZpZWxkMRYwFAYDVQQKDA1GSURPIEFsbGlhbmNlMQwwCgYDVQQLDANDV0cxNjA0BgNVBAMMLUZJRE8gRmFrZSBUUE0gUm9vdCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkgMjAxODExMC8GCSqGSIb3DQEJARYiY29uZm9ybWFuY2UtdG9vbHNAZmlkb2FsbGlhbmNlLm9yZzAeFw0xNzAyMDEwMDAwMDBaFw0zNTAxMzEyMzU5NTlaMEExPzA9BgNVBAMTNk5DVS1OVEMtS0VZSUQtMzYxMDRDRTQwQkJDQzFGNDBEODRBNEJCRDUwQkU5OTAyNEQ5NTdENDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBANc-c30RpQd-_LCoiLJbXz3t_vqciOIovwjez79_DtVgi8G9Ph-tPL-lC0ueFGBMSPcKd_RDdSFe2QCYQd9e0DtiFxra-uWGa0olI1hHI7bK2GzNAZSTKEbwgqpf8vXMQ-7SPajg6PfxSOLH_Nj2yd6tkNkUSdlGtWfY8XGB3n-q--nt3UHdUQWEtgUoTe5abBXsG7MQSuTNoad3v6vk-tLd0W44ivM6pbFqFUHchx8mGLApCpjlVXrfROaCoc9E91hG9B-WNvekJ0dM6kJ658Hy7yscQ6JdqIEolYojCtWaWNmwcfv--OE1Ax_4Ub24gl3hpB9EOcBCzpb4UFmLYUECAwEAAaOCAXcwggFzMAsGA1UdDwQEAwIBhjAWBgNVHSAEDzANMAsGCSsGAQQBgjcVHzAbBgNVHSUEFDASBgkrBgEEAYI3FSQGBWeBBQgDMBIGA1UdEwEB_wQIMAYBAf8CAQAwHwYDVR0OBBgEFsIUUX8iyOZTpXzVTN0wWH4w_2c2jF0wHwYDVR0jBBgwFqAUXH82LZCtWry6jnXa3jqg7cFOAoswaAYDVR0fBGEwXzBdoFugWYZXaHR0cHM6Ly9maWRvYWxsaWFuY2UuY28ubnovdHBtcGtpL2NybC9GSURPIEZha2UgVFBNIFJvb3QgQ2VydGlmaWNhdGUgQXV0aG9yaXR5IDIwMTguY3JsMG8GCCsGAQUFBwEBBGMwYTBfBggrBgEFBQcwAoZTaHR0cHM6Ly9maWRvYWxsaWFuY2UuY28ubnovdHBtcGtpL0ZJRE8gRmFrZSBUUE0gUm9vdCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkgMjAxOC5jcnQwDQYJKoZIhvcNAQELBQADggIBAG138t55DF9nPJbvbPQZOypmyTPpNne0A5fh69P1fHZ5qdE2PDz3cf5Tl-8OPI4xQniEFNPcXMb7KlhMM6zCl4GkZtNN4MxygdFjQ1gTZOBDpt7Dwziij0MakmwyC0RYTNtbSyVhHUevgw9rnu13EzqxPyL5JD-UqADh2Y51MS0qy7IOgegLQv-eJzSNUgHxFJreUzz4PU6yzSsTyyYDW-H4ZjAQKienVp8ewZf8oHGWHGQFGa5E9m1P8vxCMZ7pIzeQweCVYrs3q7unu4nzBAIXLPI092kYFUgyz3lIaSB3XEiPBokpupX6Zmgrfphb-XX3tbenH5hkxfumueA5RMHTMu5TVjhJXiV0yM3q5W5xrQHdJlF5nOdJDEE-Kb7nm6xaT1DDpafqBc5vEDMkJmBA4AXHUY7JPGqEEzEenT7k6Wn5IQLZg4qc8Irnj__yM7xUhJWJam47KVbLA4WFu-IKvJrkP5GSglZ9qASOCxBHaOL2UcTAg50uvhUSwur2KSak2vlENdmAijwdAL4LLQWrkFd-9NBwcNwTdfK4ekEHP1l4BwJtkNwW6etUgeA5rkW2JLocXoBq5v7GSk4_CBoKhyiahQGQQ9SZFGeBJhzzkK9yN-yKskcVjjjInSHPl-ZpeOK3sI08sEyTH0gxlTtRoX0MKDsMAHEVToe5o1u9Z3B1YkFyZWFZATYAAQALAAYEcgAgnf_L82w4OuaZ-5ho3G3LidcVOIS-KAOSLBJBWL-tIq4AEAAQCAAAAAAAAQDPtSggWlsjcFiQO61-hUF8i-3FPcyvuARcy3p1seZ-_B4ClhNh5U-T0v0flMU5p6nsNDWj4f6-soe-2vVJMTm2d26uKYD2zwdrkrYYXRu5IFqUXqF-kY99v8RcrAF7DQKDo-E4XhiMz6uECvnjEloGfTYZrVuQ1mdjQ8Qki7U-9SQHMW_IsaI8ZKHtupXNhM5YPQyFbDHHXSE_iyPGh2mY4SR466ouesIuG0NccCUk5UDIvS__OUmNaX7aBrKTlnkMFjkCA1ZDFC99ZQoLFCJQHqnOU7m8zSvTJpUyG2feWgAL2Gl05V3I_lb_v5yELXcihFoA33QIOSpDmKqKV3SXaGNlcnRJbmZvWK3_VENHgBcAIgALEeaO1E21Ny4UKW4vhKzHg5h1GIGSHjD8IqBvi3PHlFMAIBo8rAwJFDGsmQjauX_FCBQenvBa2ApBcR_gOx2qW2QAAAAAAUdwF0hVaXtLxoVgpQFzfvmNNFZV-wAiAAsXPoJSq0uhvU6VLf0uIelHBNFHEanasKAoTp-lQ2dRGAAiAAuO1HPzTRRabZhwPvHQh0b1MnLIG8EVGNfpshASWSfjQWhhdXRoRGF0YVkBZ0mWDeWIDoxodDQXD2R2YFuP5K65ooYyx5lc87qDHZdjQQAAAEOn1tk6ig0R6JqUps9xBy9zACCH1cyGRV483U-ur0qz9V_AixVm-36OZJFMSd69Nz4oH6QBAwM5AQAgWQEAz7UoIFpbI3BYkDutfoVBfIvtxT3Mr7gEXMt6dbHmfvweApYTYeVPk9L9H5TFOaep7DQ1o-H-vrKHvtr1STE5tndurimA9s8Ha5K2GF0buSBalF6hfpGPfb_EXKwBew0Cg6PhOF4YjM-rhAr54xJaBn02Ga1bkNZnY0PEJIu1PvUkBzFvyLGiPGSh7bqVzYTOWD0MhWwxx10hP4sjxodpmOEkeOuqLnrCLhtDXHAlJOVAyL0v_zlJjWl-2gayk5Z5DBY5AgNWQxQvfWUKCxQiUB6pzlO5vM0r0yaVMhtn3loAC9hpdOVdyP5W_7-chC13IoRaAN90CDkqQ5iqild0lyFDAQAB"));
        if (result.HasError)
        {
            throw new InvalidOperationException();
        }

        //var ver = new DefaultAttestationStatementVerifier<TestWebAuthnContext>(new DefaultTimeProvider(), NullLogger<DefaultAttestationStatementVerifier<TestWebAuthnContext>>.Instance);
        var ver = new DefaultAttestationStatementVerifier<TestWebAuthnContext>(
            new DefaultPackedAttestationStatementVerifier(new DefaultTimeProvider(), new DefaultDigitalSignatureVerifier()),
            new DefaultTpmAttestationStatementVerifier(),
            new DefaultAndroidKeyAttestationStatementVerifier(),
            new DefaultAndroidSafetyNetAttestationStatementVerifier(),
            new DefaultFidoU2FAttestationStatementVerifier(),
            new DefaultNoneAttestationStatementVerifier(),
            new DefaultAppleAnonymousAttestationStatementVerifier(),
            NullLogger<DefaultAttestationStatementVerifier<TestWebAuthnContext>>.Instance
        );
        await using var ctx = new TestWebAuthnContext(null);
        await ver.VerifyAttestationStatementAsync(ctx, new(
                AttestationStatementFormat.Tpm,
                result.Ok.AttStmt,
                new(
                    result.Ok.AuthData.RpIdHash,
                    result.Ok.AuthData.Flags,
                    result.Ok.AuthData.SignCount,
                    result.Ok.AuthData.AttestedCredentialData!,
                    result.Ok.RawAuthData),
                SHA256.HashData(WebEncoders.Base64UrlDecode(
                    "eyJvcmlnaW4iOiJodHRwczovL2xvY2FsaG9zdDo0NDMyOSIsImNoYWxsZW5nZSI6ImdIckFrNHBOZTJWbEIwSExlS2NsSTJQNlFFYTgzUHVHZWlqVEhNdHBiaFk5S2x5YnlobHdGX1Z6UmU3eWhhYlhhZ1d1WTZya0RXZnZ2aE5xZ2gybzdBIiwidHlwZSI6IndlYmF1dGhuLmNyZWF0ZSJ9"))),
            default);

        Assert.That(result.HasError, Is.False);
        Assert.That(result.Ok!.Fmt, Is.EqualTo(AttestationStatementFormat.Tpm));
    }

    [Test]
    public void CanDecode_Tpm_Rsa()
    {
        var result = _decoder.Decode(TpmRsaAttestationObject);
        Assert.That(result.HasError, Is.False);
        Assert.That(result.Ok!.Fmt, Is.EqualTo(AttestationStatementFormat.Tpm));
    }

    [Test]
    public void CanDecode_AndroidSafetynet()
    {
        var result = _decoder.Decode(AndroidSafetynetAttestationObject);
        Assert.That(result.HasError, Is.False);
        Assert.That(result.Ok!.Fmt, Is.EqualTo(AttestationStatementFormat.AndroidSafetynet));
    }

    [Test]
    public void CanDecode_AndroidKey()
    {
        var result = _decoder.Decode(AndroidKeyAttestationObject);
        Assert.That(result.HasError, Is.False);
        Assert.That(result.Ok!.Fmt, Is.EqualTo(AttestationStatementFormat.AndroidKey));
    }

    [Test]
    public void CanDecode_FidoU2f()
    {
        var result = _decoder.Decode(FidoU2FAttestationObject);
        Assert.That(result.HasError, Is.False);
        Assert.That(result.Ok!.Fmt, Is.EqualTo(AttestationStatementFormat.FidoU2F));
    }

    [Test]
    public void CanDecode_Apple()
    {
        var result = _decoder.Decode(AppleAttestationObject);
        Assert.That(result.HasError, Is.False);
        Assert.That(result.Ok!.Fmt, Is.EqualTo(AttestationStatementFormat.AppleAnonymous));
    }
}
